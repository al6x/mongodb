<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>persistence.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="driver.html">driver.rb</a>
          <a class="source" href="migration.html">migration.rb</a>
          <a class="source" href="persistence.html">persistence.rb</a>
          <a class="source" href="rake_migration.html">rake_migration.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>persistence.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p>Example of Ruby Object Persistence for <a href="index.html">MongoDB Enhanced Driver</a>.</p>

<p>It works by converting object graph to graph of hashes when saving to mongo,
and restoring it back when loading.</p>

<p>Objects are converted to hashes by walking over instance variables and converting them
to hash entries. Because it uses such simple approach any Ruby Object can
be easily saved to Mongo.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>Connecting to test database and cleaning it before starting the sample.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;mongo/object&#39;</span>
<span class="n">connection</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Connection</span><span class="o">.</span><span class="n">new</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">default_test</span>
<span class="n">db</span><span class="o">.</span><span class="n">drop</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Let&rsquo;s define Game Unit.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">Unit</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>Including Mongo::Object.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="kp">include</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Object</span>

  <span class="kp">attr_reader</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:stats</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>We need to also the initializer to be used without arguments.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">initialize</span> <span class="nb">name</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">stats</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="vi">@name</span><span class="p">,</span> <span class="vi">@stats</span> <span class="o">=</span> <span class="nb">name</span><span class="p">,</span> <span class="n">stats</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>Creating internal object containing stats of the Unit.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">class</span> <span class="nc">Stats</span>
    <span class="kp">include</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Object</span>
    <span class="kp">attr_accessor</span> <span class="ss">:attack</span><span class="p">,</span> <span class="ss">:life</span><span class="p">,</span> <span class="ss">:shield</span>

    <span class="k">def</span> <span class="nf">initialize</span> <span class="n">attack</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">life</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">,</span> <span class="n">shield</span> <span class="o">=</span> <span class="kp">nil</span>
      <span class="vi">@attack</span><span class="p">,</span> <span class="vi">@life</span><span class="p">,</span> <span class="vi">@shield</span> <span class="o">=</span> <span class="n">attack</span><span class="p">,</span> <span class="n">life</span><span class="p">,</span> <span class="n">shield</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>Let&rsquo;s create two Heroes.</p>

<p>It uses the same Driver API, everything works the same way as with hashes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">zeratul</span>  <span class="o">=</span> <span class="no">Unit</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;Zeratul&#39;</span><span class="p">,</span>  <span class="no">Unit</span><span class="o">::</span><span class="no">Stats</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">85</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
<span class="n">tassadar</span> <span class="o">=</span> <span class="no">Unit</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;Tassadar&#39;</span><span class="p">,</span> <span class="no">Unit</span><span class="o">::</span><span class="no">Stats</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>  <span class="mi">80</span><span class="p">,</span>  <span class="mi">300</span><span class="p">))</span>

<span class="n">db</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">save</span> <span class="n">zeratul</span>
<span class="n">db</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">save</span> <span class="n">tassadar</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>Udating, we made error &ndash; mistakenly set Tassadar&rsquo;s attack as zero, let&rsquo;s fix it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">tassadar</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">attack</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">db</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">save</span> <span class="n">tassadar</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>Querying first and all documents matching criteria (there&rsquo;s also <code>:each</code> method,
the same as <code>:all</code>).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">p</span> <span class="n">db</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Zeratul&#39;</span><span class="p">)</span>                  <span class="c1"># =&gt; zeratul</span>
<span class="nb">p</span> <span class="n">db</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Zeratul&#39;</span><span class="p">)</span>                    <span class="c1"># =&gt; [zeratul]</span>
<span class="n">db</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">all</span> <span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Zeratul&#39;</span> <span class="k">do</span> <span class="o">|</span><span class="n">unit</span><span class="o">|</span>
  <span class="nb">p</span> <span class="n">unit</span>                                           <span class="c1"># =&gt; zeratul</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>Dynamic finders, handy way to do simple queries.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">p</span> <span class="n">db</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">by_name</span><span class="p">(</span><span class="s1">&#39;Zeratul&#39;</span><span class="p">)</span>                      <span class="c1"># =&gt; zeratul</span>
<span class="nb">p</span> <span class="n">db</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">first_by_name</span><span class="p">(</span><span class="s1">&#39;Zeratul&#39;</span><span class="p">)</span>                <span class="c1"># =&gt; zeratul</span>
<span class="nb">p</span> <span class="n">db</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">all_by_name</span><span class="p">(</span><span class="s1">&#39;Zeratul&#39;</span><span class="p">)</span>                  <span class="c1"># =&gt; [zeratul]</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>Bang versions, will raise error if nothing found.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">p</span> <span class="n">db</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">first!</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="s1">&#39;Zeratul&#39;</span><span class="p">)</span>                 <span class="c1"># =&gt; zeratul</span>
<span class="nb">p</span> <span class="n">db</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">by_name!</span><span class="p">(</span><span class="s1">&#39;Zeratul&#39;</span><span class="p">)</span>                     <span class="c1"># =&gt; zeratul</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>Query sugar, use <code>:_gt</code> instead of <code>:$gt</code>. It&rsquo;s more convinient to use new hash
syntax <code>{name: {_gt: &lsquo;Z&rsquo;}}</code> instead of hashrockets <code>{name: {:$gt =&gt; &lsquo;Z&rsquo;}}</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="no">Mongo</span><span class="o">.</span><span class="n">defaults</span><span class="o">[</span><span class="ss">:convert_underscore_to_dollar</span><span class="o">]</span> <span class="o">=</span> <span class="kp">true</span>
<span class="nb">p</span> <span class="n">db</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="nb">name</span><span class="p">:</span> <span class="p">{</span><span class="n">_gt</span><span class="p">:</span> <span class="s1">&#39;Z&#39;</span><span class="p">})</span>                   <span class="c1"># =&gt; [zeratul]</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>In this example we covered Ruby Object Persistence, if You are interesting You can also take
a look at <a href="http://alexeypetrushin.github.com/mongodb_model">mongodb_model</a> &ndash; Object Model to define Business Logic of
Your Application (standalone gem).</p>

      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
